<% require 'rgeo' %>
<% require 'rgeo/geos' %>

<div class="container">
  <h1><%= t('trip_suggestions.index.title') %></h1>
  <h2><%= t('trip_suggestions.index.summary') %></h2>
  <table>
    <tr>
      <td><b><%= t('activerecord.attributes.trip_request.airport') %>:</b></td>
      <td><%= "#{@trip_request.airport.name} (#{@trip_request.airport.icao})" %></td>
    </tr>
    <tr>
      <td><b><%= t('activerecord.attributes.trip_request.start_date') %>:</b></td>
      <td><%= format_offset_date_human(@trip_request.start_date.to_date - Date.current) %></td>
    </tr>
    <tr>
      <td><b><%= t('activerecord.attributes.trip_request.end_date') %>:</b></td>
      <td><%= format_offset_date_human(@trip_request.end_date.to_date - Date.current) %></td>
    </tr>
  </table>

  <h2><%= t('trip_suggestions.index.title') %></h2>

  <% @top_destinations.each do |destination| %>
    <div>
      <div class="bg-color3 p-5 m-5"> 
        <h3 class="color-light"><%= "#{NormalizeCountry(destination[:airport].country.code, :to => :emoji)} #{destination[:airport].city} (#{destination[:airport].country.name})" %></h3>
        <p><%= "#{destination[:airport].name} (#{destination[:airport].icao})" %>
          <span class="tag-outline-dark ml-5"><%= destination[:airport].airport_type %></span>
        </p>
        <%= poi_group_to_icon(destination[:airport], @trip_request) %>
        </br>
        Is in flyzone? <%= destination[:flight_track].is_in_flyzone %>
      </div>
    </div>
  <% end %>


  <h2><%= t('trip_suggestions.index.flyzone_map') %></h2>
  <% if @fake_weather %>
    <p class="tag-danger">fake weather</p>
  <% else %>
    <p class="tag-success">real weather</p>
  <% end %>
  <p><%= @airports_flyzone_map.count %> Airports found</p>
  <div class="map-container" \
        data-controller="osm" \
        data-osm-target="map" \
        data-osm-airports-matching-criterias-map-value="<%= @airports_matching_criterias_map.to_json %>" \
        data-osm-airports-flyzone-map-value="<%= @airports_flyzone_map.to_json %>" \
        data-osm-departure-airport-value="<%= @departure_airport.first.to_json %>" \
        data-osm-flyzone-common-polygon-value="<%= @flyzone_common_polygons %>" \
        data-osm-flyzone-outbound-value="<%= @flyzone_outbound %>" \
        data-osm-flyzone-inbound-value="<%= @flyzone_inbound %>" \
        data-osm-flight-track-lines-value="<%= @top_destinations.map { |destination| RGeo::GeoJSON.encode(destination[:flight_track].line) }.to_json %>" \>
  </div>

  <div class="my-20">
    <%= link_to "New Trip Request", new_trip_request_path, class: "btn btn-secondary" %>
  </div>
</div>
